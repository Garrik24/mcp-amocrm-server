# ü§ñ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –õ–Æ–ë–´–• LLM –∫ AmoCRM –°–µ—Ä–≤–µ—Ä—É

## üìö –í–∞–∂–Ω–æ –ø–æ–Ω—è—Ç—å: MCP vs REST API

### ‚ö†Ô∏è –ì–õ–ê–í–ù–û–ï –†–ê–ó–õ–ò–ß–ò–ï:

```
MCP (Model Context Protocol)
‚îú‚îÄ –†–∞–±–æ—Ç–∞–µ—Ç –¢–û–õ–¨–ö–û —Å Claude Desktop
‚îú‚îÄ –õ–æ–∫–∞–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ stdio
‚îú‚îÄ –ù–ï —Ç—Ä–µ–±—É–µ—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ URL
‚îî‚îÄ –§–∞–π–ª: mcp_server.py

REST API (OpenAPI)
‚îú‚îÄ –†–∞–±–æ—Ç–∞–µ—Ç —Å –õ–Æ–ë–û–ô LLM
‚îú‚îÄ –¢—Ä–µ–±—É–µ—Ç HTTP –¥–æ—Å—Ç—É–ø (–ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ –ø—É–±–ª–∏—á–Ω–æ)
‚îú‚îÄ –ù—É–∂–µ–Ω URL (ngrok/Railway –¥–ª—è –æ–±–ª–∞—á–Ω—ã—Ö LLM)
‚îî‚îÄ –§–∞–π–ª: app.py
```

---

## ‚úÖ –¢–ï–ö–£–©–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê (–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è!)

–£ –≤–∞—Å **–î–í–ê –°–ï–†–í–ï–†–ê** - –∏ —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ:

### 1. MCP –°–µ—Ä–≤–µ—Ä (`mcp_server.py`)
```python
# –î–ª—è Claude Desktop (–ª–æ–∫–∞–ª—å–Ω–æ)
‚Ä¢ –ü—Ä–æ—Ç–æ–∫–æ–ª: MCP (stdio)
‚Ä¢ 24 –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
‚Ä¢ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ URL
‚Ä¢ –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å Claude Desktop
```

### 2. REST API –°–µ—Ä–≤–µ—Ä (`app.py`)
```python
# –î–ª—è –í–°–ï–• –æ—Å—Ç–∞–ª—å–Ω—ã—Ö LLM
‚Ä¢ –ü—Ä–æ—Ç–æ–∫–æ–ª: HTTP REST + OpenAPI
‚Ä¢ 15 endpoints
‚Ä¢ –¢—Ä–µ–±—É–µ—Ç URL (–ª–æ–∫–∞–ª—å–Ω—ã–π –∏–ª–∏ –ø—É–±–ª–∏—á–Ω—ã–π)
‚Ä¢ –†–∞–±–æ—Ç–∞–µ—Ç —Å: ChatGPT, Anthropic API, OpenAI API,
  –ª—é–±—ã–µ LLM —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π HTTP
```

---

## üéØ –ö–ê–ö –ü–û–î–ö–õ–Æ–ß–ò–¢–¨ –†–ê–ó–ù–´–ï LLM

### 1. Claude Desktop (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ ‚úÖ)

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç:** `mcp_server.py`  
**–ü—Ä–æ—Ç–æ–∫–æ–ª:** MCP (stdio)  
**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** `QUICKSTART.md`

```json
// ~/.config/Claude/claude_desktop_config.json
{
  "mcpServers": {
    "amocrm": {
      "command": "/path/to/venv/bin/python",
      "args": ["/path/to/mcp_server.py"]
    }
  }
}
```

---

### 2. ChatGPT (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ ‚úÖ)

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç:** `app.py` (REST API)  
**–ü—Ä–æ—Ç–æ–∫–æ–ª:** HTTP + OpenAPI  
**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** `CHATGPT_INTEGRATION.md`

**–®–∞–≥–∏:**
1. –î–µ–ø–ª–æ–π –Ω–∞ Railway/ngrok ‚Üí –ø–æ–ª—É—á–∞–µ—Ç–µ URL
2. Custom GPT ‚Üí Actions ‚Üí Import from URL:
   ```
   https://your-url/openapi.json
   ```
3. –ì–æ—Ç–æ–≤–æ!

---

### 3. Anthropic Claude API (—á–µ—Ä–µ–∑ –∫–æ–¥)

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç:** `app.py` (REST API)  
**–ü—Ä–æ—Ç–æ–∫–æ–ª:** HTTP

```python
import anthropic

client = anthropic.Anthropic(api_key="your-key")

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ tool –¥–ª—è Claude API
tools = [{
    "name": "check_contact_exists",
    "description": "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –≤ AmoCRM",
    "input_schema": {
        "type": "object",
        "properties": {
            "query": {
                "type": "string",
                "description": "Email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω"
            }
        },
        "required": ["query"]
    }
}]

# –ü—Ä–∏ –≤—ã–∑–æ–≤–µ tool –¥–µ–ª–∞–µ—Ç–µ HTTP –∑–∞–ø—Ä–æ—Å –∫ –≤–∞—à–µ–º—É —Å–µ—Ä–≤–µ—Ä—É
import requests
response = requests.post(
    "http://your-server/api/contacts/check-exists",
    params={"query": "test@example.com"}
)
```

---

### 4. OpenAI API (—á–µ—Ä–µ–∑ –∫–æ–¥)

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç:** `app.py` (REST API)

```python
from openai import OpenAI

client = OpenAI(api_key="your-key")

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ function calling
functions = [{
    "name": "check_contact_exists",
    "description": "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞",
    "parameters": {
        "type": "object",
        "properties": {
            "query": {"type": "string"}
        },
        "required": ["query"]
    }
}]

messages = [{"role": "user", "content": "–ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Ç–∞–∫—Ç test@example.com"}]

response = client.chat.completions.create(
    model="gpt-4",
    messages=messages,
    functions=functions
)

# –ü—Ä–∏ function_call –¥–µ–ª–∞–µ—Ç–µ HTTP –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
```

---

### 5. LangChain Integration

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç:** `app.py` (REST API)

```python
from langchain.tools import Tool
from langchain.agents import initialize_agent
import requests

def check_contact(query: str) -> str:
    """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç –≤ AmoCRM"""
    response = requests.post(
        "http://localhost:8000/api/contacts/check-exists",
        params={"query": query}
    )
    return response.json()

tools = [
    Tool(
        name="check_amocrm_contact",
        func=check_contact,
        description="–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞ –≤ AmoCRM"
    )
]

agent = initialize_agent(tools, llm, agent="zero-shot-react-description")
```

---

### 6. –õ—é–±–∞—è –¥—Ä—É–≥–∞—è LLM (Gemini, Mistral, LLama –∏ —Ç.–¥.)

**–ò—Å–ø–æ–ª—å–∑—É–µ—Ç:** `app.py` (REST API)

–ü—Ä–æ—Å—Ç–æ –¥–µ–ª–∞–π—Ç–µ HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ –≤–∞—à–µ–º—É —Å–µ—Ä–≤–µ—Ä—É:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞
curl -X POST "http://localhost:8000/api/contacts/check-exists?query=test@example.com"

# –£–º–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ —Å–¥–µ–ª–∫–∏
curl -X POST "http://localhost:8000/api/smart/client-and-lead" \
  -H "Content-Type: application/json" \
  -d '{
    "contact_query": "ivan@test.ru",
    "contact_name": "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
    "lead_name": "–ù–æ–≤–∞—è —Å–¥–µ–ª–∫–∞",
    "lead_price": 50000
  }'
```

---

## üîß –ß–¢–û –ù–£–ñ–ù–û –£–õ–£–ß–®–ò–¢–¨ –î–õ–Ø –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–û–ì–û –î–û–°–¢–£–ü–ê

### 1. –î–æ–±–∞–≤–∏—Ç—å CORS (–µ—Å–ª–∏ –±—É–¥—É—Ç –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)

```python
# –í app.py –¥–æ–±–∞–≤—å—Ç–µ:
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —É–∫–∞–∂–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### 2. –î–æ–±–∞–≤–∏—Ç—å API Key –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é (–¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

```python
# –í app.py –¥–æ–±–∞–≤—å—Ç–µ middleware:
from fastapi import Request, HTTPException

@app.middleware("http")
async def verify_api_key(request: Request, call_next):
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º /docs –∏ /openapi.json –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏
    if request.url.path in ["/docs", "/openapi.json", "/redoc"]:
        return await call_next(request)
    
    api_key = request.headers.get("X-API-Key")
    expected_key = os.getenv("API_KEY")
    
    if expected_key and api_key != expected_key:
        return JSONResponse(
            {"error": "Invalid API key"},
            status_code=401
        )
    
    return await call_next(request)
```

### 3. –£–ª—É—á—à–∏—Ç—å OpenAPI –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

```python
# –í app.py –æ–±–Ω–æ–≤–∏—Ç–µ:
app = FastAPI(
    title="AmoCRM Universal API",
    description="""
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π API –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ AmoCRM —Å –ª—é–±—ã–º–∏ LLM –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏.
    
    –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:
    - ChatGPT (Custom GPT Actions)
    - Claude API (Function Calling)
    - OpenAI API (Function Calling)
    - LangChain
    - –õ—é–±—ã–µ HTTP –∫–ª–∏–µ–Ω—Ç—ã
    """,
    version="3.0.0",
    servers=[
        {"url": "http://localhost:8000", "description": "–õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä"},
        {"url": "https://your-app.up.railway.app", "description": "Production"}
    ]
)
```

---

## üìä –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–° (—á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç)

| LLM/–°–µ—Ä–≤–∏—Å | –ú–µ—Ç–æ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è | –°—Ç–∞—Ç—É—Å | –§–∞–π–ª |
|------------|-------------------|--------|------|
| Claude Desktop | MCP (stdio) | ‚úÖ –ì–æ—Ç–æ–≤ | `mcp_server.py` |
| ChatGPT | Custom GPT Actions | ‚úÖ –ì–æ—Ç–æ–≤ | `app.py` |
| Claude API | REST API + tools | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | `app.py` |
| OpenAI API | REST API + functions | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | `app.py` |
| LangChain | REST API + Tools | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | `app.py` |
| –õ—é–±–æ–π HTTP –∫–ª–∏–µ–Ω—Ç | REST API | ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç | `app.py` |

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### ‚úÖ –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ü–†–ê–í–ò–õ–¨–ù–ê–Ø!

–í—ã —É–∂–µ –º–æ–∂–µ—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –ª—é–±—É—é LLM —á–µ—Ä–µ–∑ REST API (`app.py`).

### üîß –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å:

1. **–î–æ–±–∞–≤–∏—Ç—å CORS** (–µ—Å–ª–∏ –±—É–¥—É—Ç –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
2. **–î–æ–±–∞–≤–∏—Ç—å API Key** (–¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)
3. **–£–ª—É—á—à–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è** –≤ OpenAPI —Å—Ö–µ–º–µ
4. **–î–æ–±–∞–≤–∏—Ç—å rate limiting** (–¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏)
5. **–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üí° –û–¢–í–ï–¢–´ –ù–ê –í–ê–®–ò –í–û–ü–†–û–°–´

### Q: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MCP —Å–µ—Ä–≤–µ—Ä—É —á–µ—Ä–µ–∑ ChatGPT?

**A:** –î–∞, –Ω–æ —Å —É—Ç–æ—á–Ω–µ–Ω–∏–µ–º:
- ChatGPT **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç MCP** –Ω–∞–ø—Ä—è–º—É—é (MCP —Ç–æ–ª—å–∫–æ –¥–ª—è Claude Desktop)
- ChatGPT –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ **REST API** (`app.py`)
- –≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è ChatGPT

### Q: –ú–æ–∂–µ—Ç –ª–∏ –ª—é–±–∞—è LLM –∫–æ–Ω–Ω–µ–∫—Ç–∏—Ç—å—Å—è –∫ –Ω–∞—à–µ–º—É MCP?

**A:** 
- –ö **MCP —Å–µ—Ä–≤–µ—Ä—É** (`mcp_server.py`) - –ù–ï–¢, —Ç–æ–ª—å–∫–æ Claude Desktop
- –ö **REST API** (`app.py`) - –î–ê, –ª—é–±–∞—è LLM!

**–ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞:**  
"–õ—é–±–∞—è LLM –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –Ω–∞—à–µ–º—É **REST API —Å–µ—Ä–≤–µ—Ä—É** —á–µ—Ä–µ–∑ HTTP"

---

## üöÄ –ß–¢–û –î–ï–õ–ê–¢–¨ –î–ê–õ–¨–®–ï

### –î–ª—è ChatGPT:
1. –°–ª–µ–¥—É–π—Ç–µ `CHATGPT_INTEGRATION.md`
2. –î–µ–ø–ª–æ–π –Ω–∞ Railway/ngrok
3. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ OpenAPI schema

### –î–ª—è –¥—Ä—É–≥–∏—Ö LLM:
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `app.py` (REST API —Å–µ—Ä–≤–µ—Ä)
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ URL: `http://localhost:8000`
3. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: `http://localhost:8000/docs`
4. –î–µ–ª–∞–π—Ç–µ HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ endpoints

### –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø:
```bash
# –î–µ–ø–ª–æ–π –Ω–∞ Railway (–ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π URL)
# –∏–ª–∏
ngrok http 8000  # –≤—Ä–µ–º–µ–Ω–Ω—ã–π URL –¥–ª—è —Ç–µ—Å—Ç–æ–≤
```

---

## üìö –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û

### –ü—Ä–∏–º–µ—Ä—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:

**Python (–ª—é–±–∞—è LLM):**
```python
import requests

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞
response = requests.post(
    "http://localhost:8000/api/contacts/check-exists",
    params={"query": "test@example.com"}
)
print(response.json())
```

**JavaScript:**
```javascript
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–∞
const response = await fetch(
  'http://localhost:8000/api/contacts/check-exists?query=test@example.com',
  { method: 'POST' }
);
const data = await response.json();
console.log(data);
```

**cURL:**
```bash
curl -X POST "http://localhost:8000/api/smart/client-and-lead" \
  -H "Content-Type: application/json" \
  -d '{
    "contact_query": "ivan@test.ru",
    "contact_name": "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
    "lead_name": "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è",
    "lead_price": 50000
  }'
```

---

## ‚úÖ –í–´–í–û–î

**–í–∞—à–∞ —Ç–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å –ª—é–±—É—é LLM!**

- Claude Desktop ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `mcp_server.py` (MCP)
- –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `app.py` (REST API)

–ù–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞.  
–ú–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —É–ª—É—á—à–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (API key, CORS, rate limiting).

---

**–í–µ—Ä—Å–∏—è:** 1.0  
**–û–±–Ω–æ–≤–ª–µ–Ω–æ:** –û–∫—Ç—è–±—Ä—å 2025

